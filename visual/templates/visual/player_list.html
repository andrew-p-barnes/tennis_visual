{% extends 'visual/base.html' %}
{% block content %}

<div>
    <h1>Event List</h1>
</div>

{% for event in events %}
    <div>
        <h2>name: {{ event.name }}</h2>
        <p>year: {{ event.year }}</p>
        <p>type: {{ event.ranking_type }}</p>
        <p>setting: {{ event.setting }}</p>
        <p>surface: {{ event.court_surface }}</p>
    </div>
{% endfor %}

<select class="selectpicker" multiple id="playerPickerSelect">
    {% for player in players %}
    <option value="{{ player.first_name }} {{ player.last_name }}" selected>{{ player.first_name }} {{ player.last_name }}</option>
    {% endfor %}
</select>
<button type="button" class="btn btn-default" id="playerPickerBtn">Pick players</button>

<div id="myBarChartWrapper"></div>
<div id="myStackedBarChartWrapper"></div>
<div id="myPieChartWrapper"></div>

<script>
$(document).ready(function() {
    $('.selectpicker').selectpicker();
});

var events;
var barChart;
var pieChart;
var stackedBarChart;

let promise = new Promise(function(resolve, reject) {
    $.ajax({
        type: "GET",
        url: "event",
        success: function(events_json){
            events = events_json;
            console.log(events);
            resolve(console.log("it works"));
        }
    })
});

promise.then(function(result) {

    function prepareBarChartLabels(events) {

        console.log(events.length);

        var yearsSet = new Set();

        for (var i = 0; i < events.length; i++) {
            yearsSet.add(events[i].year);
        }

        var yearsArray = Array.from(yearsSet);
        yearsArray.sort();
        return yearsArray;
    }

    function prepareBarChartData(events, barChartLabels) {

        var numEventsMap = new Map();

        for (var i = 0; i < barChartLabels.length; i++) {
            numEventsMap.set(barChartLabels[i], 0);
        }

        for (var i = 0; i < events.length; i++) {
            var eventCount = numEventsMap.get(events[i].year);
            eventCount++;
            numEventsMap.set(events[i].year, eventCount);
        }

        console.log(numEventsMap);

        var numEventsArray = [];

        for (var i = 0; i < barChartLabels.length; i++) {
            var eventCount = numEventsMap.get(barChartLabels[i]);
            numEventsArray.push(eventCount);
        }
        return numEventsArray;
    }

    function drawBarChart(barChartLabels, barChartData) {

        if (document.getElementById('myBarChart')) {
            var chartCanvas = document.getElementById('myBarChart');
            chartCanvas.parentNode.removeChild(chartCanvas);
        }

        chartCanvas = document.createElement("canvas");
        chartCanvas.setAttribute("id","myBarChart");
        chartCanvas.setAttribute("width","100");
        chartCanvas.setAttribute("height","100");
        document.getElementById('myBarChartWrapper').appendChild(chartCanvas);

        var bar_ctx = document.getElementById('myBarChart');
        barChart = new Chart(bar_ctx, {
            type: 'bar',
            data: {
                labels: barChartLabels,
                datasets: [{
                    label: '# of Events',
                    data: barChartData,
                    backgroundColor: [
                        'rgba(153, 102, 255, 0.2)',
                        'rgba(255, 159, 64, 0.2)',
                        'rgba(5, 9, 64, 0.2)',
                        'rgba(55, 15, 64, 0.2)',
                        'rgba(205, 159, 64, 0.2)'
                    ],
                    borderColor: [
                        'rgba(153, 102, 255, 1)',
                        'rgba(255, 159, 64, 1)',
                        'rgba(5, 9, 64, 0.2)',
                        'rgba(55, 15, 64, 0.2)',
                        'rgba(205, 159, 64, 0.2)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    yAxes: [{
                        ticks: {
                            beginAtZero: true
                        }
                    }]
                }
            }
        });
    }

    function preparePieChartLabels(events) {

        var surfacesSet = new Set();

        for (var i = 0; i < events.length; i++) {
            surfacesSet.add(events[i].court_surface);
        }

        var surfacesArray = Array.from(surfacesSet);
        surfacesArray.sort();
        return surfacesArray;
    }

    function preparePieChartData(events, pieChartLabels) {

        var numEventsMap = new Map();

        for (var i = 0; i < pieChartLabels.length; i++) {
            numEventsMap.set(pieChartLabels[i], 0);
        }

        for (var i = 0; i < events.length; i++) {
            var eventCount = numEventsMap.get(events[i].court_surface);
            eventCount++;
            numEventsMap.set(events[i].court_surface, eventCount);
        }

        console.log(numEventsMap);

        var numEventsArray = [];

        for (var i = 0; i < pieChartLabels.length; i++) {
            var eventCount = numEventsMap.get(pieChartLabels[i]);
            numEventsArray.push(eventCount);
        }
        return numEventsArray;
    }

    function drawPieChart(pieChartLabels, pieChartData) {

        if (document.getElementById('myPieChart')) {
            var chartCanvas = document.getElementById('myPieChart');
            chartCanvas.parentNode.removeChild(chartCanvas);
        }

        chartCanvas = document.createElement("canvas");
        chartCanvas.setAttribute("id","myPieChart");
        chartCanvas.setAttribute("width","100");
        chartCanvas.setAttribute("height","100");
        document.getElementById('myPieChartWrapper').appendChild(chartCanvas);

        var pie_ctx = document.getElementById('myPieChart');
        var pieChart = new Chart(pie_ctx, {
            type: 'pie',
            data: {
                labels: pieChartLabels,
                datasets: [{
                    data: pieChartData,
                    backgroundColor: [
                        'rgba(153, 102, 255, 0.2)',
                        'rgba(53, 102, 255, 0.2)',
                        'rgba(255, 159, 64, 0.2)',
                        'rgba(200, 19, 64, 0.2)'
                    ],
                    borderColor: [
                        'rgba(153, 102, 255, 1)',
                        'rgba(53, 102, 255, 1)',
                        'rgba(255, 159, 64, 1)',
                        'rgba(200, 19, 64, 0.2)'
                    ],
                    borderWidth: 1
                }]
            }
        });
    }

    function prepareStackedBarChartAxisLabels(events) {

        console.log(events.length);

        var yearsSet = new Set();

        for (var i = 0; i < events.length; i++) {
            yearsSet.add(events[i].year);
        }

        var yearsArray = Array.from(yearsSet);
        yearsArray.sort();
        console.log("stack years array");
        console.log(yearsArray);
        return yearsArray;
    }

    function prepareStackedBarChartColumnLabels(events) {

        console.log(events.length);

        var playersSet = new Set();

        for (var i = 0; i < events.length; i++) {
            playersSet.add(events[i].last_name);
        }

        var playersArray = Array.from(playersSet);
        playersArray.sort();
        console.log("stack players array");
        console.log(playersArray);
        return playersArray;
    }

    function prepareStackedBarChartData(events, stackedBarChartAxisLabels, stackedBarChartColumnLabels) {

        numEventsData = [];
        console.log("players in stacked data");
        console.log(stackedBarChartColumnLabels.length);

        for (var i = 0; i < stackedBarChartColumnLabels.length; i++) {

            console.log(stackedBarChartColumnLabels[i]);
            var numEventsMap = new Map();

            for (var j = 0; j < stackedBarChartAxisLabels.length; j++) {
                numEventsMap.set(stackedBarChartAxisLabels[j], 0);
            }

            console.log(stackedBarChartColumnLabels[i]);

            for (var j = 0; j < events.length; j++) {
                var eventCount = numEventsMap.get(events[j].year);
                if (events[j].last_name ===  stackedBarChartColumnLabels[i]) {
                    eventCount++;
                    numEventsMap.set(events[j].year, eventCount);
                }
            }
            console.log(stackedBarChartColumnLabels[i]);
            console.log(numEventsMap);

            var numEventsArray = [];

            for (var j = 0; j < stackedBarChartAxisLabels.length; j++) {
                var eventCount = numEventsMap.get(stackedBarChartAxisLabels[j]);
                numEventsArray.push(eventCount);
            }
            numEventsData.push(numEventsArray);
        }

        backgroundColorArray = ['rgba(255, 99, 132, 0.2)', 'rgba(54, 162, 235, 0.2)', 'rgba(255, 206, 86, 0.2)', 'rgba(75, 192, 192, 0.2)', 'rgba(153, 102, 255, 0.2)', 'rgba(255, 159, 64, 0.2)'];

        var stackedBarChartData = {};
        stackedBarChartData.labels = stackedBarChartAxisLabels;
        var playerDatasets = [];

        for (var i = 0; i < stackedBarChartColumnLabels.length; i++) {
            var playerDataset = {};
            playerDataset.label = stackedBarChartColumnLabels[i];
            playerDataset.backgroundColor = backgroundColorArray[i];
            playerDataset.data = numEventsData[i];
            playerDatasets.push(playerDataset);
        }
        stackedBarChartData.datasets = playerDatasets;
        console.log(stackedBarChartData);
        return stackedBarChartData;
    }

    function drawStackedBarChart(stackedBarChartData) {

        if (document.getElementById('myStackedBarChart')) {
            var chartCanvas = document.getElementById('myStackedBarChart');
            chartCanvas.parentNode.removeChild(chartCanvas);
        }

        chartCanvas = document.createElement("canvas");
        chartCanvas.setAttribute("id","myStackedBarChart");
        chartCanvas.setAttribute("width","100");
        chartCanvas.setAttribute("height","100");
        document.getElementById('myStackedBarChartWrapper').appendChild(chartCanvas);

        var bar_ctx = document.getElementById('myStackedBarChart');
        barChart = new Chart(bar_ctx, {
            type: 'bar',
            data: stackedBarChartData,
            options: {
			    title: {
					display: true,
					text: 'Chart.js Bar Chart - Stacked'
				},
				tooltips: {
					mode: 'index',
					intersect: false
				},
				responsive: true,
				scales: {
					xAxes: [{
						stacked: true,
					}],
					yAxes: [{
						stacked: true
					}]
				}
			}
		});
	};

    barChartLabels = prepareBarChartLabels(events);
    barChartData = prepareBarChartData(events, barChartLabels);
    drawBarChart(barChartLabels, barChartData);

    pieChartLabels = preparePieChartLabels(events);
    pieChartData = preparePieChartData(events, pieChartLabels);
    drawPieChart(pieChartLabels, pieChartData);

    stackedBarChartAxisLabels = prepareStackedBarChartAxisLabels(events);
    console.log(stackedBarChartAxisLabels);
    stackedBarChartColumnLabels = prepareStackedBarChartColumnLabels(events);
    console.log(stackedBarChartColumnLabels);
    stackedBarChartData = prepareStackedBarChartData(events, stackedBarChartAxisLabels, stackedBarChartColumnLabels);
    console.log(stackedBarChartData);
    drawStackedBarChart(stackedBarChartData);

    $("#playerPickerBtn").on( "click", function() {
        console.log("player picker");
        var players = $("#playerPickerSelect").val();
        var playersArray = players.toString().split(",");
        console.log("players picked " + playersArray);
        var playersLastNameArray = [];
        var playersLastNameStr = "";
        for (var i = 0; i < playersArray.length; i++) {
            playersLastNameArray.push(playersArray[i].split(" ")[1]);
            playersLastNameStr = playersLastNameStr + " " + playersArray[i].split(" ")[1];
        }
        playersLastNameStr = playersLastNameStr.trim();
        console.log(playersLastNameArray);
        console.log(playersLastNameStr);

        $.ajax({
            type: "GET",
            url: "select_player",
            data: {lastNames: playersLastNameStr},
            success: function(selected_events_json){
                selectedEvents = selected_events_json;
                console.log(selectedEvents);
                barChartLabels = prepareBarChartLabels(selectedEvents);
                barChartData = prepareBarChartData(selectedEvents, barChartLabels);
                console.log(barChartLabels);
                console.log(barChartData);
                drawBarChart(barChartLabels, barChartData);
                pieChartLabels = preparePieChartLabels(selectedEvents);
                pieChartData = preparePieChartData(selectedEvents, pieChartLabels);
                drawPieChart(pieChartLabels, pieChartData);
                stackedBarChartAxisLabels = prepareStackedBarChartAxisLabels(selectedEvents);
                stackedBarChartColumnLabels = prepareStackedBarChartColumnLabels(selectedEvents);
                stackedBarChartData = prepareStackedBarChartData(selectedEvents, stackedBarChartAxisLabels, stackedBarChartColumnLabels);
                drawStackedBarChart(stackedBarChartData);
            }
        })
    });
});

</script>

<button type="button" id="player_details_btn">Display player details</button>

<script>
    $('#player_details_btn').click(function(){
    console.log("clicked")
        $.ajax({
            type: "GET",
            url: "player",
            success: function(players_json){
                players = JSON.parse(players_json);
                console.log(players)
                var div = document.createElement("div");
                div.id = "player_details";
                document.body.appendChild(div);
                for (var i = 0; i < players.length; i++) {
                    var name = document.createElement("p");
                    name.innerText = "Player name: " + players[i].fields.first_name + " " + players[i].fields.last_name;
                    document.getElementById("player_details").appendChild(name);
                    var dob = document.createElement("p");
                    dob.innerText = "Date of birth: " + players[i].fields.date_of_birth;
                    document.getElementById("player_details").appendChild(dob);
                    var nationality = document.createElement("p");
                    nationality.innerText = "Nationality: " + players[i].fields.nationality;
                    document.getElementById("player_details").appendChild(nationality);
                }
            }
        })
    });

</script>

{% endblock %}